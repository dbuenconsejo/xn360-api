# Quick notes: generate SSH keys and add secrets before using this workflow
# 1) Generate keypair (local machine):
#    ssh-keygen -t ed25519 -C "deploy@xn360" -f ~/.ssh/xn360_deploy
#    (or: ssh-keygen -t rsa -b 4096 -C "deploy@xn360" -f ~/.ssh/xn360_deploy)
# 2) Install public key on EC2 (as the deploy user):
#    ssh-copy-id -i ~/.ssh/xn360_deploy.pub -p <PORT> deploy@EC2_HOST
#    OR manually:
#    ssh deploy@EC2_HOST "mkdir -p ~/.ssh && chmod 700 ~/.ssh && cat >> ~/.ssh/authorized_keys" < ~/.ssh/xn360_deploy.pub
#    chmod 600 /home/deploy/.ssh/authorized_keys
# 3) Add private key contents (~/.ssh/xn360_deploy) as repository secret named: EC2_SSH_KEY
# 4) Also set these repo secrets: EC2_HOST, EC2_USER, EC2_SSH_PORT
#    (If your image is private you'd add GHCR_USERNAME and GHCR_PAT; not needed for public images.)
# 5) Test: ssh -i ~/.ssh/xn360_deploy -p <PORT> deploy@EC2_HOST
# OPTIONAL: enable passwordless sudo for 'deploy' (recommended for CI):
#   echo 'deploy ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/deploy
#   sudo chmod 440 /etc/sudoers.d/deploy
# To remove the account password (not recommended; prefer SSH keys instead):
#   sudo passwd -d deploy
# To restore/set a password:
#   echo "deploy:YourNewStrongPassword" | sudo chpasswd
# Quick test (from your machine):
#   ssh -i ~/.ssh/xn360_deploy -p <PORT> deploy@EC2_HOST "sudo -n true && echo OK || echo PASSWORD_REQUIRED"

# Recommended repository secrets (minimum for deployment)
# - EC2_HOST        : EC2 public IP or DNS
# - EC2_USER        : remote user (e.g. deploy)
# - EC2_SSH_PORT    : SSH port (usually 22)
# - EC2_SSH_KEY     : private SSH key (full contents, include BEGIN/END and newlines)
#
# Optional / recommended app secrets (store these instead of committing .env)
# - APP_KEY, DB_HOST, DB_PORT, DB_DATABASE, DB_USERNAME, DB_PASSWORD
# - REDIS_PASSWORD, MAIL_HOST, MAIL_USERNAME, MAIL_PASSWORD, etc.
#
# Private registry (only if needed)
# - GHCR_USERNAME, GHCR_PAT  (only if your image is private on ghcr.io)
#
# Example: create .env on the EC2 host from secrets (replace steps in your deploy script)
# (This avoids committing .env â€” add these secrets in repo and then in the ssh action run:)
#   cat > /home/${{ secrets.EC2_USER }}/xn360-api/.env <<'EOF'
#   APP_KEY=${{ secrets.APP_KEY }}
#   APP_ENV=production
#   DB_CONNECTION=mysql
#   DB_HOST=${{ secrets.DB_HOST }}
#   DB_PORT=${{ secrets.DB_PORT }}
#   DB_DATABASE=${{ secrets.DB_DATABASE }}
#   DB_USERNAME=${{ secrets.DB_USERNAME }}
#   DB_PASSWORD=${{ secrets.DB_PASSWORD }}
#   MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
#   MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
#   EOF
#
# Use the workflow's existing scp/ssh steps to place or generate .env securely.

name: CI Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure remote deploy directory exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          script: |
            mkdir -p /home/${{ secrets.EC2_USER }}/xn360-api

      - name: Copy docker-compose to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          source: docker-compose.yml
          target: /home/${{ secrets.EC2_USER }}/xn360-api/docker-compose.yml

      - name: Copy application source to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          # copy repo contents; adjust exclude patterns locally if you want to skip large dirs
          source: .
          target: /home/${{ secrets.EC2_USER }}/xn360-api

      - name: Copy .env to EC2 (optional - if you keep .env in repo, otherwise manage env on server)
        if: ${{ always() }}
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          source: .env
          target: /home/${{ secrets.EC2_USER }}/xn360-api/.env

      - name: Run docker-compose on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT }}
          script: |
            set -e
            cd /home/${{ secrets.EC2_USER }}/xn360-api
            # If .env is missing and .env.example exists, create .env from .env.example
            if [ ! -f .env ] && [ -f .env.example ]; then
              cp .env.example .env
              echo ".env created from .env.example"
            fi
            # Optionally adjust ownership if needed (requires passwordless sudo for deploy user):
            # sudo chown -R $USER:$USER /home/${{ secrets.EC2_USER }}/xn360-api || true
            docker-compose pull || true
            docker-compose up -d --remove-orphans
